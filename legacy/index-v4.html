<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Union Chant v3 - CORRECTED</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background: #5568d3;
        }
        .cell {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
            border-radius: 5px;
        }
        .cell.completed {
            border-left-color: #48bb78;
            background: #f0fff4;
        }
        .vote-option {
            display: inline-block;
            margin: 5px;
            padding: 8px 15px;
            background: #e3f2fd;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .vote-option:hover {
            border-color: #667eea;
        }
        .participant-btn {
            background: #667eea;
            margin: 3px;
            padding: 8px 12px;
            font-size: 14px;
        }
        .participant-btn.selected {
            background: #f59e0b;
            font-weight: bold;
        }
        .participant-btn.voted {
            background: #48bb78;
            cursor: default;
        }
        .voting-area {
            background: #f8f9fa;
            padding: 15px;
            margin-top: 10px;
            border-radius: 5px;
        }
        .idea-vote-btn {
            display: inline-block;
            margin: 5px;
            padding: 10px 20px;
            background: #e3f2fd;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid #667eea;
            font-size: 16px;
        }
        .idea-vote-btn:hover {
            background: #667eea;
            color: white;
        }
        .stats {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .tally {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>üó≥Ô∏è Union Chant v3 - CORRECTED Logic</h1>

    <div class="stats" id="stats"></div>

    <div class="controls">
        <h3>Controls</h3>
        <button onclick="addParticipant()">‚ûï Add Participant</button>
        <button onclick="addMultiple(5)">‚ûï Add 5</button>
        <button onclick="addMultiple(15)">‚ûï Add 15</button>
        <button onclick="completeTier()">‚úÖ Complete Current Tier</button>
        <button onclick="reset()">üîÑ Reset</button>
    </div>

    <div id="cells"></div>

    <script>
        const API_URL = 'http://localhost:3003/api';
        let participantCount = 0;
        let currentState = null;
        let selectedParticipant = null;
        let selectedCell = null;

        async function addParticipant() {
            participantCount++;
            await fetch(`${API_URL}/add-participant`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: `P${participantCount}` })
            });
            await updateState();
        }

        async function addMultiple(count) {
            for (let i = 0; i < count; i++) {
                await addParticipant();
                await new Promise(resolve => setTimeout(resolve, 50));
            }
        }

        async function completeTier() {
            if (!currentState) return;

            try {
                const response = await fetch(`${API_URL}/complete-tier`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tier: currentState.currentTier })
                });

                const result = await response.json();

                if (result.winner) {
                    alert(`üèÜ WINNER: ${result.winner.id}`);
                } else if (result.error) {
                    alert(result.error);
                }

                await updateState();
            } catch (e) {
                console.error('Error:', e);
            }
        }

        function selectParticipant(cellId, participantId) {
            selectedParticipant = participantId;
            selectedCell = cellId;
            updateState();
        }

        async function castVote(cellId, ideaId) {
            if (!selectedParticipant || selectedCell !== cellId) {
                alert('Please select a participant first!');
                return;
            }

            await fetch(`${API_URL}/vote`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    cellId,
                    ideaId,
                    participantId: selectedParticipant
                })
            });

            selectedParticipant = null;
            selectedCell = null;
            await updateState();
        }

        async function autoVoteCell(cellId) {
            await fetch(`${API_URL}/auto-vote`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cellId })
            });

            await updateState();
        }

        async function updateState() {
            const response = await fetch(`${API_URL}/state`);
            currentState = await response.json();

            // Stats
            let statsHtml = `<strong>Participants:</strong> ${currentState.participants} | `;
            statsHtml += `<strong>Current Tier:</strong> ${currentState.currentTier} | `;
            statsHtml += `<strong>Cells:</strong> ${currentState.cells.length}`;

            if (currentState.ideas.length > 0) {
                statsHtml += `<br><br><strong>Ideas in Play:</strong><br>`;
                currentState.ideas.forEach(idea => {
                    statsHtml += `${idea.id}: ${idea.totalVotes} votes | `;
                });
            }

            document.getElementById('stats').innerHTML = statsHtml;

            // Cells
            let cellsHtml = '<h2>Cells</h2>';

            const tierCells = {};
            currentState.cells.forEach(c => {
                if (!tierCells[c.tier]) tierCells[c.tier] = [];
                tierCells[c.tier].push(c);
            });

            Object.keys(tierCells).sort((a, b) => b - a).forEach(tier => {
                cellsHtml += `<h3>Tier ${tier}</h3>`;

                tierCells[tier].forEach(cell => {
                    const isCompleted = cell.status === 'completed';
                    cellsHtml += `<div class="cell ${isCompleted ? 'completed' : ''}">`;
                    cellsHtml += `<strong>${cell.id}</strong> - ${cell.status}<br>`;
                    cellsHtml += `Votes: ${cell.votesCast}/${cell.votesNeeded}<br>`;

                    if (Object.keys(cell.voteTally).length > 0) {
                        cellsHtml += `<div class="tally"><strong>Tally:</strong> `;
                        Object.keys(cell.voteTally).forEach(ideaId => {
                            cellsHtml += `${ideaId}: ${cell.voteTally[ideaId]} | `;
                        });
                        cellsHtml += `</div>`;
                    }

                    if (!isCompleted) {
                        cellsHtml += `<div class="voting-area">`;
                        cellsHtml += `<strong>1. Select participant:</strong><br>`;

                        cell.participants.forEach(pId => {
                            const hasVoted = cell.participantsWhoVoted.includes(pId);
                            const isSelected = selectedParticipant === pId && selectedCell === cell.id;
                            const btnClass = hasVoted ? 'voted' : (isSelected ? 'selected' : '');

                            cellsHtml += `<button class="participant-btn ${btnClass}"
                                onclick="selectParticipant('${cell.id}', '${pId}')"
                                ${hasVoted ? 'disabled' : ''}>
                                ${pId} ${hasVoted ? '‚úì' : ''}
                            </button> `;
                        });

                        cellsHtml += `<br><br><strong>2. Click idea to vote:</strong><br>`;
                        cell.ideaIds.forEach(ideaId => {
                            cellsHtml += `<button class="idea-vote-btn"
                                onclick="castVote('${cell.id}', '${ideaId}')">
                                ${ideaId}
                            </button> `;
                        });

                        cellsHtml += `<br><br>`;
                        cellsHtml += `<button onclick="autoVoteCell('${cell.id}')" style="background: #48bb78;">ü§ñ Auto-Complete This Cell</button>`;

                        cellsHtml += `</div>`;
                    }

                    cellsHtml += `</div>`;
                });
            });

            document.getElementById('cells').innerHTML = cellsHtml;
        }

        async function reset() {
            await fetch(`${API_URL}/reset`, { method: 'POST' });
            participantCount = 0;
            await updateState();
        }

        // Auto-update
        setInterval(updateState, 3000);
        updateState();
    </script>
</body>
</html>
