<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Union Chant v7 - STABLE</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        .phase {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background: #5568d3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        button.primary {
            background: #48bb78;
        }
        button.primary:hover {
            background: #38a169;
        }
        .stats {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .delegation-info {
            background: #e6f7ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #1890ff;
        }
        .cell {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
            border-radius: 5px;
        }
        .cell.completed {
            border-left-color: #48bb78;
            background: #f0fff4;
        }
        .cell.tier-1 {
            border-left-color: #667eea;
        }
        .cell.tier-2 {
            border-left-color: #f59e0b;
        }
        .cell.tier-3 {
            border-left-color: #10b981;
        }
        .participant-btn {
            background: #667eea;
            margin: 3px;
            padding: 8px 12px;
            font-size: 14px;
        }
        .participant-btn.selected {
            background: #f59e0b;
            font-weight: bold;
        }
        .participant-btn.voted {
            background: #48bb78;
            cursor: default;
        }
        .voting-area {
            background: #f8f9fa;
            padding: 15px;
            margin-top: 10px;
            border-radius: 5px;
        }
        .idea-vote-btn {
            display: inline-block;
            margin: 5px;
            padding: 10px 20px;
            background: #e3f2fd;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid #667eea;
            font-size: 16px;
        }
        .idea-vote-btn:hover {
            background: #667eea;
            color: white;
        }
        .tally {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>üó≥Ô∏è Union Chant v7 - STABLE</h1>

    <div class="phase" id="phase"></div>

    <div class="delegation-info" id="delegationInfo"></div>

    <div class="stats" id="stats"></div>

    <div class="controls">
        <h3>Controls</h3>
        <button onclick="addParticipant()">‚ûï Add Participant (+ Idea)</button>
        <button onclick="addMultiple(5)">‚ûï Add 5</button>
        <button onclick="addMultiple(15)">‚ûï Add 15</button>
        <button onclick="addMultiple(100)">‚ûï Add 100</button>
        <br><br>
        <button class="primary" onclick="startVoting()" id="startVotingBtn">üöÄ Start Voting (Calculate Architecture)</button>
        <button onclick="autoVoteAll()" id="autoVoteAllBtn" disabled style="background: #f59e0b;">‚ö° Auto-Vote All Cells</button>
        <button onclick="completeTier()" id="completeTierBtn" disabled>‚úÖ Complete Current Tier</button>
        <button onclick="reset()">üîÑ Reset</button>
    </div>

    <div id="cells"></div>

    <script>
        const API_URL = 'http://localhost:3008/api';
        let participantCount = 0;
        let currentState = null;
        let selectedParticipant = null;
        let selectedCell = null;

        async function addParticipant() {
            participantCount++;
            await fetch(`${API_URL}/add-participant`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: `P${participantCount}` })
            });
            await updateState();
        }

        async function addMultiple(count) {
            for (let i = 0; i < count; i++) {
                await addParticipant();
                await new Promise(resolve => setTimeout(resolve, 20));
            }
        }

        async function startVoting() {
            const response = await fetch(`${API_URL}/start-voting`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const result = await response.json();
            if (result.error) {
                alert(result.error);
            } else {
                alert(`Voting started! ${result.cellsFormed} cells formed.`);
            }

            await updateState();
        }

        async function completeTier() {
            if (!currentState) return;

            const response = await fetch(`${API_URL}/complete-tier`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tier: currentState.currentTier })
            });

            const result = await response.json();

            if (result.winner) {
                alert(`üèÜ WINNER: ${result.winner.id} - ${result.winner.text}`);
            } else if (result.error) {
                alert(result.error);
            } else {
                alert(`Tier ${currentState.currentTier} complete! ${result.advancingIdeas} idea(s) advance to Tier ${result.nextTier}`);
            }

            await updateState();
        }

        function selectParticipant(cellId, participantId) {
            selectedParticipant = participantId;
            selectedCell = cellId;
            updateState();
        }

        async function castVote(cellId, ideaId) {
            if (!selectedParticipant || selectedCell !== cellId) {
                alert('Please select a participant first!');
                return;
            }

            await fetch(`${API_URL}/vote`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    cellId,
                    ideaId,
                    participantId: selectedParticipant
                })
            });

            selectedParticipant = null;
            selectedCell = null;
            await updateState();
        }

        async function autoVoteCell(cellId) {
            await fetch(`${API_URL}/auto-vote`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cellId })
            });

            await updateState();
        }

        async function autoVoteAll() {
            const response = await fetch(`${API_URL}/auto-vote-all`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const result = await response.json();

            if (result.error) {
                alert(result.error);
            } else {
                alert(`‚ö° Auto-voted all cells! ${result.votesAdded} votes cast across ${result.cellsCompleted} cells.`);
            }

            await updateState();
        }

        async function updateState() {
            const response = await fetch(`${API_URL}/state`);
            currentState = await response.json();

            // Phase indicator
            const phaseText = {
                'submission': 'üìù SUBMISSION PHASE - Add participants',
                'voting': 'üó≥Ô∏è VOTING PHASE - Delegates vote in cells',
                'completed': 'üèÜ COMPLETED - Winner declared!'
            };
            document.getElementById('phase').innerHTML = phaseText[currentState.phase] || currentState.phase;

            // Scalable model info - everyone votes in every tier
            const tierCells = currentState.cells.filter(c => c.tier === currentState.currentTier);
            const activeIdeas = currentState.ideas.filter(i => i.tier === currentState.currentTier && i.status === 'in-voting');

            let delegationHtml = '<strong>Scalable Model - Everyone Votes:</strong> ';
            delegationHtml += `Tier ${currentState.currentTier} - All ${currentState.totalParticipants} participants vote on ${activeIdeas.length} idea(s)`;

            if (tierCells.length > 0) {
                delegationHtml += ` (${tierCells.length} cells of ~${tierCells[0].participants.length} people each)`;
            }

            document.getElementById('delegationInfo').innerHTML = delegationHtml;

            // Update button states
            document.getElementById('startVotingBtn').disabled = currentState.phase !== 'submission';
            document.getElementById('autoVoteAllBtn').disabled = currentState.phase !== 'voting';

            // Enable "Complete Tier" only if in voting phase AND all current tier cells are completed
            const currentTierCells = currentState.cells.filter(c => c.tier === currentState.currentTier);
            const allCurrentTierCellsCompleted = currentTierCells.length > 0 &&
                currentTierCells.every(c => c.status === 'completed');
            document.getElementById('completeTierBtn').disabled =
                currentState.phase !== 'voting' || !allCurrentTierCellsCompleted;

            // Stats
            let statsHtml = `<strong>Total Population:</strong> ${currentState.totalParticipants} | `;
            statsHtml += `<strong>Ideas:</strong> ${currentState.ideas.length} | `;
            statsHtml += `<strong>Current Tier:</strong> ${currentState.currentTier} | `;
            statsHtml += `<strong>Cells:</strong> ${currentState.cells.length}`;

            document.getElementById('stats').innerHTML = statsHtml;

            // Cells
            let cellsHtml = '<h2>Cells</h2>';

            const tierCellsMap = {};
            currentState.cells.forEach(c => {
                if (!tierCellsMap[c.tier]) tierCellsMap[c.tier] = [];
                tierCellsMap[c.tier].push(c);
            });

            Object.keys(tierCellsMap).sort((a, b) => b - a).forEach(tier => {
                cellsHtml += `<h3>Tier ${tier}</h3>`;

                tierCellsMap[tier].forEach(cell => {
                    const isCompleted = cell.status === 'completed';
                    const tierClass = `tier-${Math.min(tier, 3)}`;
                    cellsHtml += `<div class="cell ${tierClass} ${isCompleted ? 'completed' : ''}">`;
                    cellsHtml += `<strong>${cell.id}</strong> - ${cell.status}<br>`;
                    cellsHtml += `Votes: ${cell.votesCast}/${cell.votesNeeded}<br>`;
                    cellsHtml += `Ideas: ${cell.ideaIds.length}<br>`;
                    cellsHtml += `Participants: ${cell.participants.length}<br>`;

                    if (Object.keys(cell.voteTally).length > 0) {
                        cellsHtml += `<div class="tally"><strong>Tally:</strong> `;
                        Object.keys(cell.voteTally).forEach(ideaId => {
                            const idea = currentState.ideas.find(i => i.id === ideaId);
                            const ideaText = idea ? idea.text : ideaId;
                            cellsHtml += `${ideaText}: ${cell.voteTally[ideaId]} | `;
                        });
                        cellsHtml += `</div>`;
                    }

                    if (!isCompleted && currentState.phase === 'voting') {
                        cellsHtml += `<div class="voting-area">`;
                        cellsHtml += `<strong>1. Select participant:</strong><br>`;

                        cell.participants.forEach(pId => {
                            const hasVoted = cell.participantsWhoVoted.includes(pId);
                            const isSelected = selectedParticipant === pId && selectedCell === cell.id;
                            const btnClass = hasVoted ? 'voted' : (isSelected ? 'selected' : '');

                            cellsHtml += `<button class="participant-btn ${btnClass}"
                                onclick="selectParticipant('${cell.id}', '${pId}')"
                                ${hasVoted ? 'disabled' : ''}>
                                ${pId} ${hasVoted ? '‚úì' : ''}
                            </button> `;
                        });

                        cellsHtml += `<br><br><strong>2. Click idea to vote:</strong><br>`;
                        cell.ideaIds.forEach(ideaId => {
                            const idea = currentState.ideas.find(i => i.id === ideaId);
                            const ideaText = idea ? idea.text : ideaId;

                            cellsHtml += `<button class="idea-vote-btn"
                                onclick="castVote('${cell.id}', '${ideaId}')">
                                ${ideaText}
                            </button> `;
                        });

                        cellsHtml += `<br><br>`;
                        cellsHtml += `<button onclick="autoVoteCell('${cell.id}')" style="background: #48bb78;">ü§ñ Auto-Complete This Cell</button>`;

                        cellsHtml += `</div>`;
                    }

                    cellsHtml += `</div>`;
                });
            });

            document.getElementById('cells').innerHTML = cellsHtml;
        }

        async function reset() {
            await fetch(`${API_URL}/reset`, { method: 'POST' });
            participantCount = 0;
            selectedParticipant = null;
            selectedCell = null;
            await updateState();
        }

        // Auto-update
        setInterval(updateState, 3000);
        updateState();
    </script>
</body>
</html>
